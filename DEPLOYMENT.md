# Dwell India - Server Deployment Guide

## üìã Prerequisites

- Ubuntu 20.04+ or similar Linux distribution
- Sudo privileges
- Git installed
- Domain name (optional, for production)

---

## üöÄ Quick Start (Automated Setup)

### 1. Clone the Repository
```bash
git clone <your-repo-url> Dwell-India
cd Dwell-India
```

### 2. Run Setup Script
```bash
chmod +x setup.sh
./setup.sh
```

The script will automatically:
- ‚úÖ Install Python 3.11+
- ‚úÖ Install Node.js 18+
- ‚úÖ Set up virtual environments
- ‚úÖ Install all dependencies
- ‚úÖ Create configuration files
- ‚úÖ Initialize the database
- ‚úÖ Install PM2 for process management

### 3. Configure Environment Variables

**Backend (`backend/.env`):**
```env
DATABASE_URL=sqlite:///./dwell_india.db
SECRET_KEY=<auto-generated>
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# Update these with your credentials
GOOGLE_CLIENT_ID=your_actual_google_client_id
GOOGLE_CLIENT_SECRET=your_actual_google_client_secret

ALLOWED_ORIGINS=http://localhost:5173,http://your-domain.com
```

**Frontend (`web/.env`):**
```env
VITE_API_URL=http://localhost:8000
VITE_GOOGLE_CLIENT_ID=your_actual_google_client_id
```

### 4. Start the Application

**Development Mode:**
```bash
# Terminal 1 - Backend
cd backend
source venv/bin/activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Terminal 2 - Frontend
cd web
npm run dev -- --host 0.0.0.0
```

**Production Mode (with PM2):**
```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup  # Enable auto-start on reboot
```

---

## üîß Manual Setup (Step-by-Step)

### Step 1: System Dependencies

```bash
# Update system
sudo apt-get update && sudo apt-get upgrade -y

# Install Python 3.11+
sudo apt-get install -y python3.11 python3.11-venv python3-pip

# Install Node.js 18+
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# Install build tools
sudo apt-get install -y build-essential libssl-dev libffi-dev
```

### Step 2: Backend Setup

```bash
cd backend

# Create virtual environment
python3 -m venv venv
source venv/bin/activate

# Install dependencies
pip install --upgrade pip
pip install -r requirements.txt

# Create .env file (see configuration above)
nano .env

# Initialize database
python seed.py

# Test backend
uvicorn app.main:app --reload
```

### Step 3: Frontend Setup

```bash
cd web

# Install dependencies
npm install

# Create .env file (see configuration above)
nano .env

# Build for production (optional)
npm run build

# Test frontend
npm run dev
```

---

## üåê Production Deployment with Nginx

### 1. Install Nginx
```bash
sudo apt-get install -y nginx
```

### 2. Configure Nginx
```bash
sudo nano /etc/nginx/sites-available/dwell-india
```

**Nginx Configuration:**
```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # Frontend (React)
    location / {
        proxy_pass http://localhost:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Backend API
    location /api {
        rewrite ^/api/(.*) /$1 break;
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket support for Vite HMR
    location /ws {
        proxy_pass http://localhost:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }
}
```

### 3. Enable Site
```bash
sudo ln -s /etc/nginx/sites-available/dwell-india /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 4. SSL with Let's Encrypt (Optional)
```bash
sudo apt-get install -y certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

---

## üîÑ Process Management with PM2

### Start Services
```bash
pm2 start ecosystem.config.js
```

### Monitor Services
```bash
pm2 status          # View status
pm2 logs            # View logs
pm2 monit           # Real-time monitoring
```

### Manage Services
```bash
pm2 restart all     # Restart all services
pm2 stop all        # Stop all services
pm2 delete all      # Remove all services
```

### Auto-Start on Reboot
```bash
pm2 save
pm2 startup
```

---

## üìä Database Management

### Backup Database
```bash
cd backend
cp dwell_india.db dwell_india_backup_$(date +%Y%m%d).db
```

### Reset Database
```bash
cd backend
source venv/bin/activate
rm dwell_india.db  # Delete existing database
python seed.py     # Recreate and seed
```

### View Database
```bash
cd backend
sqlite3 dwell_india.db
.tables
SELECT * FROM users LIMIT 5;
.quit
```

---

## üîí Security Checklist

- [ ] Update `SECRET_KEY` in backend/.env with a strong random key
- [ ] Configure Google OAuth credentials
- [ ] Set up firewall (UFW)
  ```bash
  sudo ufw allow 22    # SSH
  sudo ufw allow 80    # HTTP
  sudo ufw allow 443   # HTTPS
  sudo ufw enable
  ```
- [ ] Enable SSL/TLS with Let's Encrypt
- [ ] Set up regular database backups
- [ ] Configure CORS origins properly
- [ ] Use environment-specific configurations

---

## üêõ Troubleshooting

### Backend Issues

**Port 8000 already in use:**
```bash
lsof -ti:8000 | xargs kill -9
```

**Database errors:**
```bash
cd backend
rm dwell_india.db
python seed.py
```

**Python dependencies:**
```bash
cd backend
source venv/bin/activate
pip install --upgrade -r requirements.txt
```

### Frontend Issues

**Port 5173 already in use:**
```bash
lsof -ti:5173 | xargs kill -9
```

**Node modules issues:**
```bash
cd web
rm -rf node_modules package-lock.json
npm install
```

**Build errors:**
```bash
cd web
npm run build -- --debug
```

### PM2 Issues

**Services not starting:**
```bash
pm2 logs --err
pm2 delete all
pm2 start ecosystem.config.js
```

**Memory issues:**
```bash
pm2 restart all --update-env
```

---

## üìà Monitoring & Logs

### View Logs
```bash
# PM2 logs
pm2 logs

# Backend logs
tail -f logs/backend-error.log
tail -f logs/backend-out.log

# Frontend logs
tail -f logs/frontend-error.log
tail -f logs/frontend-out.log

# Nginx logs
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### System Resources
```bash
# CPU and Memory
htop

# Disk usage
df -h

# PM2 monitoring
pm2 monit
```

---

## üîÑ Updating the Application

```bash
# Pull latest changes
git pull origin main

# Update backend
cd backend
source venv/bin/activate
pip install -r requirements.txt
deactivate

# Update frontend
cd ../web
npm install

# Restart services
pm2 restart all
```

---

## üìû Support

For issues or questions:
- Check logs: `pm2 logs`
- Review documentation: `/docs/PRD.md`
- Check API docs: `http://localhost:8000/docs`

---

## üéØ Production Checklist

- [ ] All environment variables configured
- [ ] Database initialized and seeded
- [ ] Google OAuth credentials set up
- [ ] Nginx configured and running
- [ ] SSL certificate installed
- [ ] Firewall configured
- [ ] PM2 auto-start enabled
- [ ] Database backup strategy in place
- [ ] Monitoring set up
- [ ] Domain DNS configured
- [ ] CORS origins updated for production domain

---

**üè† Dwell India - Trust-Anchored Real Estate Platform**
